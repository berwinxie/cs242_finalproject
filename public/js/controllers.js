var musicControllers=angular.module("musicControllers",[]);musicControllers.controller("InstrumentController",["$scope","$routeParams","$http","$timeout",function($scope,$routeParams,$http,$timeout){$scope.whichInstrument=$routeParams.whichInstrument,$scope.instrument={},$scope.song={},$scope.voiceList=responsiveVoice.getVoices(),$scope.startTime=(new Date).getTime(),$scope.visible={keyboard:!1,drums:!1,voice:!1},$scope.playedNotes=[],$scope.synth=new Tone.PolySynth(4,Tone.SimpleSynth).toMaster(),$scope.drumCompress=new Tone.Compressor({threshold:-30,ratio:6,attack:.3,release:.1}).toMaster(),$scope.distortion=new Tone.Distortion({distortion:.4,wet:.4}),$scope.hats=new Tone.Sampler("./data/audio/hh.mp3",{envelope:{attack:.001,decay:.02,sustain:.01,release:.01},filterEnvelope:{attack:.001,decay:.02,sustain:1,baseFrequency:6e3,octaves:-3.3},filter:{type:"highpass"}}).chain($scope.distortion,$scope.drumCompress),$scope.snare=new Tone.Sampler("./data/audio/snare.mp3",{envelope:{attack:.01,decay:.05,sustain:0},filterEnvelope:{attack:.001,decay:.01,sustain:0,baseFrequency:3e3,octaves:2}}).chain($scope.distortion,$scope.drumCompress),$scope.kick=new Tone.DrumSynth({pitchDecay:.01,octaves:6,oscillator:{type:"square4"},envelope:{attack:.001,decay:.2,sustain:0}}).connect($scope.drumCompress),$scope.bass=new Tone.SimpleFM({harmonicity:1,modulationIndex:3.5,carrier:{oscillator:{type:"custom",partials:[0,1,0,2]},envelope:{attack:.08,decay:.3,sustain:0}},modulator:{oscillator:{type:"square"},envelope:{attack:.1,decay:.2,sustain:.3,release:.01}}}).toMaster(),"piano"==$scope.whichInstrument&&($scope.visible.keyboard=!0,$scope.visible.drums=!1,$scope.visible.voice=!1),"drums"==$scope.whichInstrument&&($scope.visible.keyboard=!1,$scope.visible.drums=!0,$scope.visible.voice=!1),"voice"==$scope.whichInstrument&&($scope.visible.keyboard=!1,$scope.visible.drums=!1,$scope.visible.voice=!0),$scope.socket=io.connect(window.location.href),$scope.socket.on("foundUser",function(data){console.log("connected"),console.log(data)}),$scope.socket.on("getNote",function(data){console.log("got a note");var curtime=(new Date).getTime(),timestamp=curtime-$scope.startTime;data.timestamp=timestamp,$scope.addNotes(data)}),$scope.sendNote=function(note,duration,drumType){var username=$scope.username;(""===username||void 0===username)&&(username="anon"),$scope.socket.emit("playNote",{note:note,duration:duration,message:"Sent a note!",instrument:$scope.whichInstrument,username:username,drumType:drumType})},$scope.addNotes=function(note){$scope.playNote(note.playedNote,note.duration,note.drumType,note.instrument),"drums"==note.instrument&&(note.playedNote=note.drumType),$scope.playedNotes.push(note),$scope.$digest()},$scope.playNote=function(note,duration,drumType,instrument){if("piano"===instrument)$scope.synth.triggerAttackRelease(note,duration);else if("drums"===instrument)"snare"==drumType&&$scope.snare.triggerAttackRelease(note,.5),"kick"==drumType&&$scope.kick.triggerAttackRelease(note,.5),"hats"==drumType&&$scope.hats.triggerAttackRelease(note,.5),"bass"==drumType&&$scope.bass.triggerAttackRelease(note,.5);else if("voice"===instrument){var voice=duration,params=drumType;""!==duration&&void 0!==duration?responsiveVoice.speak(note,voice,params):responsiveVoice.speak(note,"US English Female",params)}},$scope.playSong=function(inputtedData){$scope.playedNotes=[];for(var notes=JSON.parse(inputtedData),i=0;i<notes.length;i++){var note=notes[i];console.log(note),("snare"==note.playedNote||"hats"==note.playedNote)&&(note.playedNote=0),("kick"==note.playedNote||"bass"==note.playedNote)&&(note.playedNote="C4")}$scope.timeInMs=0;var curIndex=0,play=function(){notes[curIndex].timestamp<$scope.timeInMs&&(note=notes[curIndex],console.log("note at "+notes[curIndex].timestamp),$scope.addNotes(note),curIndex+=1,curIndex>notes.length)||($scope.timeInMs+=10,console.log($scope.timeInMs),$timeout(play,10))};$timeout(play,10)}}]);